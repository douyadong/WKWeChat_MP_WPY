<!--
    @页面名称：经纪人首页
    @作者：豆亚东 (douyadong@lifang.com)
    @业务逻辑说明：
        1.
        2.        
-->
<template lang="wxml">
    <view class="agent">
        <view class="card">
            <image src="{{agentInfo.headRoundImgUrl}}?x-oss-process=image/resize,w_120"  mode="aspectFill" lazy-load="true"></image>
            <view class="agent-info">
                <view class="id-info">
                    <text class="name">{{agentInfo.agentName}}</text>
                    <text class="company">| {{agentInfo.abbreviation}} {{agentInfo.storeName}}</text>
                </view>
                <view class="join-long">入住悟空：{{agentInfo.serviceYears}}</view>
            </view>      
        </view>
        <view class="house-number">TA的房源<text class="number">[{{houseInfo.total}}套]</text></view>
        <view class="house-list">
            <repeat for="{{houseInfo.secondHouseListModels}}" key="index" index="index" item="item">
                <esf :item="item"></esf>
            </repeat>
        </view>
    </view>
    <assistant :agent.sync="agentInfo" portrait="off" wechatEventName="1218002" telEventName="1218003"></assistant>
</template>

<script>
    import wepy from "wepy";
    import Esf from "../../components/esf";
    import Assistant from "../../components/assistant";
    import apiDataFilter from "../../mixins/apiDataFilter";
    import Trace from "../../mixins/trace" ;  //大数据埋点 api
    export default class Index extends wepy.page {
        config = {
            
        };
        components = {
            esf: Esf,
            assistant: Assistant
        };
        data = {
            pageParams:{},//页面query参数;
            agentInfo: '',//经纪人身份信息;
            houseInfo:'',//房源列表信息;
            trace:new Trace, //埋点api
            pageStates:{
                    pageIndex:0,//评论的起始条数
                    pageSize:20,//评论信息每次加载多少条
                    total:0
            }
        };
        computed = {

        };
        methods = {

        };
        events = {

        };
        onLoad(options) {
            let self=this;
            self.pageParams=options;
            //页面刚开始加载时获取的房源列表信息;
            apiDataFilter.request({
                apiPath : "agent.house" ,
                data : { 
                    "agentId":options.agentId ,
                    "pageIndex":self.pageStates.pageIndex,
                    "pageSize":self.pageStates.pageSize, 
                    } ,
                successCallback:function(res){
                    self.houseInfo=res.data;
                    self.pageStates.pageIndex += (res.secondHouseListModels&& res.secondHouseListModels.length || 0);
                    self.houseInfo.secondHouseListModels.forEach((item)=>{
                        item.bigDataParam = {eventName:"1218001",eventParam:{house_id:item.houseId,agent_id:self.pageParams.agentId}};
                    });
                    self.$apply();
                }
            });
            //经济人身份信息;
            apiDataFilter.request({
                apiPath : "agent.index" ,
                data : { "agentId":options.agentId } ,
                successCallback:function(res){
                    self.agentInfo=res.data;
                    self.$apply();
                     //动态改变页面title;
                    wx.setNavigationBarTitle({title:self.agentInfo.agentName+'的名片'});
                }
            });
            // 页面埋点;
            self.trace.pv({"pageName" : "1218","pageParam":{"agent_id":self.pageParams.agentId}})
        };
        onReachBottom(options) {
            // 页面上拉触发该函数用于滚动加载数据
            //经纪人房源信息;
            let self=this;
            // 判断房源是否加载完毕;
            if(self.houseInfo.total!=self.houseInfo.secondHouseListModels.length){
                 apiDataFilter.request({
                    apiPath : "agent.house",
                    data : { 
                        "agentId":options.agentId,
                        "pageIndex":self.pageStates.pageIndex,
                        "pageSize":self.pageStates.pageSize, 
                    } ,
                    successCallback:function(res){
                        if(res.data){
                            self.houseInfo.secondHouseListModels= self.houseInfo.secondHouseListModels.concat(res.data.secondHouseListModels);
                            self.pageStates.pageIndex += (res.data.secondHouseListModels&& res.data.secondHouseListModels.length || 0);
                            self.houseInfo.secondHouseListModels.forEach((item)=>{
                            item.bigDataParam = {eventName:"1218001",eventParam:{house_id:item.houseId,agent_id:self.pageParams.agentId}};
                            });
                            self.$apply();
                        }   
                    }
                })
            }
        };
        // 分享转发;
        onShareAppMessage() {
            return { "title" : this.agentInfo.storeName+'经纪人'+this.agentInfo.agentName+'的名片' }
        }
    }
</script>

<style lang="less" scoped>
    @import "../../less/variables.less";
    @import "../../less/mixins.less"; 
    // 经纪人信息;
    .agent {
        background-color: #fff;
        padding-bottom: 130rpx;
        .card {
            border-bottom: 1rpx solid #d8d8d8;
            .clearfix();
            padding: 30rpx;
            image {
                float: left;
                height: 120rpx;
                width: 120rpx;
            }
            .agent-info {
                margin-left: 150rpx;
                .id-info {
                    font-size: 32rpx;
                    margin-bottom: 22rpx;
                    .name {
                        margin-right: 20rpx;
                    }
                    .company {
                        color: @lighter-font-color;
                    }
                }
                .join-long {
                    color: @lighter-font-color;
                    font-size: 28rpx;
                }
            }
        } 
        // 经纪人有多少房源
        .house-number {
            font-size: 32rpx;
            margin-top: 30rpx;
            padding: 0 30rpx;
            .number {
                color: @lighter-font-color;
            }
        } 
        // 房源列表;
        .house-list {
            // .clearfix();
            padding-left: 30rpx;
        }
    }
</style>