<!--
    @页面名称：二手房列表页面
    @作者：赵华刚 (zhaohuagang@lifang.com)
    @业务逻辑说明：
        1.
        2.        
-->
<template lang="wxml">
    <view>
       <repeat for="{{ houseList }}" key="index" index="index" item="item">
            <esf :item="item"></esf>
        </repeat>
    </view>
</template>

<script>
    import wepy from "wepy" ;
    /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    载入组件资源
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    import Esf from "../../components/esf" ;
    /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    载入工具资源
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    import Trace from "../../mixins/trace" ;  //大数据埋点 api
    /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面逻辑
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    export default class List extends wepy.page {
        components = {            
            esf : Esf
        } ; 
        data = {
            apiPath : "" , //到底调用哪个接口的数据来渲染页面
            houseList : [] ,
            pageParams : {} ,
            pageStates : {
                "offset" : 0 ,  //数据偏移量
                "pageSize" : 20 , //每页显示多少条
                "requestable" : true //是否可以继续请求，如果结果加载完了就不能请求了
            } ,
            trace : new Trace
        } ;
        onLoad(options) {
            /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            将页面query参数值存放到data下的pageParams下
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
            this.pageParams = options ;            
            /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            根据页面参数type来决定页面navigatorTitle写什么
            1. type=onsale : 小区在售房源
            2. type=similar : 相似房源
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
            let pageTitle ;
            let pageName = "" ; 
            let pageParam = {} ;

            switch(this.pageParams.type) {
                case "onsale" : 
                pageTitle = "小区在售房源" ;
                pageName = "1216" ;
                pageParam = { "estate_id" : this.pageParams.estateId } ;
                this.apiPath = "estate.onSale" ;
                break ;

                case "similar" : 
                pageTitle = "相似房源" ;
                pageName = "1217" ;
                this.apiPath = "esf.similar" ; 
                break ;

                default :
                pageTitle = "房源列表" ;
                this.apiPath = "esf.list" ;             
                break ;
            }
            wx.setNavigationBarTitle({
                "title" : pageTitle
            }) ;
            /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            页面埋点
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
            this.trace.pv({ "pageName" : pageName , "pageParam" : pageParam }) ;
        } ;
        onShow() {
            if(this.pageStates.requestable) this.loadData() ;
        } ;
        onReachBottom() {
            if(this.pageStates.requestable) this.loadData() ;
        }
        loadData() {
            let reqData = { "offset" : this.pageStates.offset , "pageSize" : this.pageStates.pageSize } ;
            if( this.pageParams.type === "onsale" ) reqData.subEstateId = this.pageParams.estateId ;
            else if( this.pageParams.type === "similar" ) reqData.houseId = this.pageParams.houseId ;
            /*++-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
            从api接口读取数据
            -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/                  
           adf.request({
                apiPath : this.apiPath ,
                data : reqData ,
                successCallback : (res)=> {
                    if(res.data.length) {
                        this.houseList = this.houseList.concat(res.data) ;
                        this.pageStates.offset += res.data.length ;
                    }                    
                    if( this.houseList.length === res.count ) this.pageStates.requestable = false ;  //如果加载完了要改变标识
                    this.$apply() ;           
                }
            }) ;
        } ;
        onShareAppMessage() {
            return { "title" : "买房就找悟空找房" }
        }
    }
</script>

<style lang="less">
    
</style>