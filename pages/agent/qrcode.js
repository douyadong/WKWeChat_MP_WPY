/*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
1. 项目名称：悟空找房+微信小程序
2. 文件名：pages -> agent -> qrcode.js
3. 作者：zhaohuagang@lifang.com
4. 备注：添加经纪人微信页面脚本逻辑
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
import request from "../../utils/request";
let bigData = require('../../utils/bigData');
let app = getApp();
/*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
定义页面初始化参数
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
let params = {
    data: {
        "pageParams": {}, //页面参数对象     
    },
    /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    渲染页面方法
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    render: function() {
        let _ = this;
        request.fetch({
            "module": "agent",
            "action": "getAgentInfo",
            "mock": false,
            "data": {
                "agentId": _.data.pageParams.agentId
            },
            success: function(res) {
                let result = res.data;
                //经纪人公司名称取得规则：有简称显示简称，无简称显示全称，全称也没有就不显示
                let abbreviation = result.abbreviation;
                let companyName = result.companyName;
                let finalCompanyName = abbreviation ? abbreviation : (companyName ? companyName : "");
                result.cardName = finalCompanyName + "经纪人" + result.agentName;
                _.setData(res.data);
                /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
                 设置导航栏标题，格式为："公司名称 经纪人名称"
                 -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
                wx.setNavigationBarTitle({
                    title: result.cardName
                });
            },
            fail: function() {
                wx.showModal({
                    "title": "错误提示",
                    "content": res.message,
                    "showCancel": false,
                    "confirmText": "我知道了"
                });
            }
        });
    },
    /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    页面加载完触发
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    onLoad: function(options) {
        //把页面参数保存到页面数据中
        this.setData({
            "pageParams": options
        });
        this.render();
    },
    onShareAppMessage: function() {
        return {
            "title": "买房卖房，找好经纪人就对了！"
        }
    },
    copyWechatId: function() {
        /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
        将微信号赋值到剪贴板
        -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
        wx.setClipboardData({
            data: this.data.agentWChatId,
            success: function() {
                app.showTips('经纪人微信号已复制到剪切板!')
            }
        });
    },
    /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    保存经纪人小程序二维码
    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    saveAgentQRCode: function(event) {
      this.bigData(event);
        wx.showModal({
            "title": "提示",
            "content": "需要保存到相册吗？",
            "success": function(res) {
                wx.getSetting({
                    success(res) {
                        if (!res['scope.writePhotosAlbum']) {
                            wx.authorize({
                                scope: 'scope.writePhotosAlbum',
                                success() {
                                    wx.downloadFile({
                                        url: event.currentTarget.dataset.url,
                                        success: function(res) {
                                            wx.saveImageToPhotosAlbum({
                                                filePath: res.tempFilePath,
                                                success(res) {
                                                    app.showTips('已保存到手机相册!')
                                                },
                                                fail(res) {
                                                    wx.showToast({
                                                        "title": "保存到相册失败，请搜索经纪人微信号码添加微信！"
                                                    })
                                                }
                                            })
                                        },
                                        fail: function() {
                                            wx.showToast({
                                                "title": "保存到相册失败，请搜索经纪人微信号码添加微信！"
                                            })
                                        }
                                    })
                                },
                                fail(res) {
                                    wx.showToast({
                                        "title": "保存到相册失败，请搜索经纪人微信号码添加微信!"
                                    })
                                }
                            })
                        }
                    }
                })
            }
        })
    },
    /*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
    埋点    -----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
    bigData: function (e) {
      bigData.send(e.currentTarget.dataset);
    }
};
/*++----------------------------------------------------------------------------------------------------------------------------------------------------------------------
实例化页面
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------++*/
Page(params);
